---
title: "FinalProjectDraft"
author: "Breanna Schneider, Avery Chan, Maja Velichkovich"
date: "4/11/2021"
output:
  html_document:
    toc: yes
    toc_float: true
    number_sections: true
    theme: united
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE, echo = TRUE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, rows.print=11)
library(tidyverse)
# install.packages(DT)
library(DT)
options(dplyr.summarise.inform = FALSE)
```

# Introduction

Spotify is one of the larger music streaming services available today with 345 million active users ^[https://newsroom.spotify.com/company-info/]. Instead of having to buy cds or download every song to listen to, Spotify allows access to millions of songs without having to download them on electronic devices.

In our project, we want to discover the most popular genre. In addition, our other question is if a feature has a strong correlation to certain other features. Our data will specify a few genres that may be the most popular. Certain features will be strongly correlated to other features. 

# Background 

The data we are using is based on Spotify data from 1921 to 2020 including over 175,000 audio tracks.We found our data on Kaggle ^[https://www.kaggle.com/yamaerenay/spotify-dataset-19212020-160k-tracks?select=data_by_artist_o.csv]. This dataset groups the data by artist, genre, and year. There are nine different variables measured in the dataset. They are acousticness, danceability, duration, energy, liveness, instrumentalness, loudness, speechiness, valence, popularity, and tempo.

Energy is a perceptual measure of the intensity and activity of a track on a scale from 0.0 to 1.0. Some of the perceptual features that are included in this are dynamic range, perceived loudness, timbre, onset rate, and general entropy. Liveness ranges from 0 to 1 and detects if an audience is present in a recording. If the liveness value is above 0.8, there is a strong likelihood that the track is live. Acousticness is the confidence measure of the track being acoustic. It varies from 0.0 to 1.0, with 1.0 representing high confidence that the track is acoustic. Loudness ranges from -60 to 0 and is measured in decibels (dB). It suggests the overall loudless averaged over the entire track. The measure of danceability includes a combination of tempo,  rhythm stability, beat strength and regularity. It rates how suitable a track is for dancing from 0.0 to 1.0 with 1 being the most danceable. Duration measures the length of the track in milliseconds (ms). The instrumentalness feature tracks whether a song contains vocals. “Ooh” and “aah” sounds are treated as instrumental in this context. Rap or spoken word tracks are considered vocal. Instrumentalness ranges from 0 to 1.0 with 1.0 being the most instrumental. Speechiness is the opposite of instrumentalness, measuring the relative length of the track containing any kind of human voice. The tempo feature gives information on the tempo of the track in Beat Per Minute (BPM). Valence measures the positiveness of the track, higher valence relates to more cheerful and upbeat songs. Lastly, popularity is calculated by an algorithm that is based on the total number of plays the track has had and how recent those plays are. 

In the rest of our report, we intend to first group the genres into broader categories and then analyze the features throughout the genres. We want to discover which genres are the most popular by using t-tests comparing the genre popularity means. We will also compare features to each other and test the correlations between two features to see if they have a strong linear relationship or not. In the end, we hope to discover how popularity is related to different genres, as well and how different features relate to each other.

# Analysis

## Genre Condensation {.tabset .tabset-pills}

```{r}
genre <- read_csv("data/data_by_genres.csv", col_types = cols())
num_genres <- genre %>% nrow()
x <- genre %>% 
  select(genres) %>% 
  mutate(
    words = str_split(genres, "\\s"),
  )
all_terms <- tibble(term = unlist(x$words, recursive = FALSE))
# Top terms (double counts...)
genre_term_count <- all_terms %>% 
  group_by(term) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>% 
  head(20)
```

There were ``r num_genres`` genres. We condensed these into the top 20 occurring terms in these genres using regular expressions and counting the occurrences.

### All genres

Here are all the original genres.

```{r}
genre %>% 
  select(genres) %>% 
  DT::datatable()
```

### Top 100

This is the top 100 terms found from all the genres. These will be used to create the simplified genres.

```{r}
all_terms %>% 
  group_by(term) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>% 
  head(100)
```

### Top 20

```{r}
num_simp <- all_terms %>% 
  group_by(term) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>% 
  head(20) %>% 
  summarise(
    n = sum(n)
  ) %>% pull(n)
```


These are the top 20 terms found. They are the ones we will use. Note this only uses ``r round(num_simp / num_genres, 3) * 100`%` of the data since ``r round(1 - num_simp / num_genres, 3) * 100`%` of the data do not fall under these top 20 categories.

```{r}
# Top terms (double counts...)
all_terms %>% 
  group_by(term) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>% 
  head(20)
```

### Final Condensed Gernre Dataset

We use these top 20 to create a more concisely labeled dataset (along with the label other).

```{r}
# higher in case when get priority
condensed <- genre %>% 
  mutate(
    simple_genre = case_when(
      str_detect(genres, genre_term_count$term[1]) ~ genre_term_count$term[1],
      str_detect(genres, genre_term_count$term[2]) ~ genre_term_count$term[2],
      str_detect(genres, genre_term_count$term[3]) ~ genre_term_count$term[3],
      str_detect(genres, genre_term_count$term[4]) ~ genre_term_count$term[4],
      str_detect(genres, genre_term_count$term[5]) ~ genre_term_count$term[5],
      str_detect(genres, genre_term_count$term[6]) ~ genre_term_count$term[6],
      str_detect(genres, genre_term_count$term[7]) ~ genre_term_count$term[7],
      str_detect(genres, genre_term_count$term[8]) ~ genre_term_count$term[8],
      str_detect(genres, genre_term_count$term[9]) ~ genre_term_count$term[9],
      str_detect(genres, genre_term_count$term[10]) ~ genre_term_count$term[10],
      str_detect(genres, genre_term_count$term[11]) ~ genre_term_count$term[11],
      str_detect(genres, genre_term_count$term[12]) ~ genre_term_count$term[12],
      str_detect(genres, genre_term_count$term[13]) ~ genre_term_count$term[13],
      str_detect(genres, genre_term_count$term[14]) ~ genre_term_count$term[14],
      str_detect(genres, genre_term_count$term[15]) ~ genre_term_count$term[15],
      str_detect(genres, genre_term_count$term[16]) ~ genre_term_count$term[16],
      str_detect(genres, genre_term_count$term[17]) ~ genre_term_count$term[17],
      str_detect(genres, genre_term_count$term[18]) ~ genre_term_count$term[18],
      str_detect(genres, genre_term_count$term[19]) ~ genre_term_count$term[19],
      str_detect(genres, genre_term_count$term[20]) ~ genre_term_count$term[20],
      TRUE ~ "other"
    )
  )

condensed %>% 
  group_by(simple_genre) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n))
```

### Condensed genre conunts

This graph shows the number of occurrances of each simplified genre.

```{r}
condensed %>% 
  group_by(simple_genre) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>% 
  ggplot(aes(y = simple_genre, x = n, fill=simple_genre)) +
  geom_col() +
  theme_bw()
```

### Condensed genre counts (removed "other")

This graph shows the number of occurrances of each simplified genre without the "other" category.

```{r}
condensed %>% 
  group_by(simple_genre) %>% 
  filter(simple_genre != "other") %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>% 
  ggplot(aes(y = simple_genre, x = n, fill = simple_genre)) +
  geom_col() +
  theme_bw()
```

## Feature Correlations

### r-values

#### All Combinations of Features {.tabset .tabset-pills}

The second question we want to answer is to see if any features have strong linear correlations to other features. First, we found r-value combinations between all of the features, which is shown in the table below. 

##### Raw r-values

The raw r-values

```{r rows.print=11}
year <- read_csv("data/data_by_year.csv", col_types = cols())

# All r values
year %>% 
  select(-c(year, key, mode)) %>% 
  cor() %>% 
  round(digits = 2) %>% 
  data.frame()
```

##### Correlation plot

The r-values in an easier to view format. The red and blue show signify higher correlations.

```{r}
# > install.packages("corrplot")
library(corrplot)

# year %>% glimpse()

year2 <- year %>% 
  rename(
    yr = year,
    ac = acousticness,
    db = danceability,
    dur = duration_ms,
    en = energy,
    ins = instrumentalness,
    li = liveness,
    lo = loudness,
    sp = speechiness,
    tmp = tempo,
    val = valence,
    pop = popularity,
    k = key,
    m = mode
  )
corrplot.mixed(
  round(cor(year2[2:12]), 1),
  lower = "number",
  upper = "color"
)
```

#### Filter r values {.tabset .tabset-pills}

As this table shows, some features seem to have strong linear relationships, while some features seem to not have a strong linear relationship. Next, we filtered for the absolute value of r-values only over `.9` to find the strongest feature relations. You can see some other thresholds below. We chose `.9` as a threshold arbitrarily since there were many features that correlated.

##### threshold = `0.9`

```{r rows.print=11}
year <- read_csv("data/data_by_year.csv", col_types = cols())
year2 <- year %>% 
  rename(
    yr = year,
    ac = acousticness,
    db = danceability,
    dur = duration_ms,
    en = energy,
    ins = instrumentalness,
    li = liveness,
    lo = loudness,
    sp = speechiness,
    tmp = tempo,
    val = valence,
    pop = popularity,
    k = key,
    m = mode
  )

library(corrr)
allr2 <- year %>% 
  select(-c(year, key, mode)) %>% 
  correlate()

allr3 <- allr2

threshold = 0.9
b1 <- allr3 < threshold
b2 <- allr3 > -threshold
allr3[b1 & b2] <- NA # only check values that are above threshold for r

allr <- year2 %>%
  select(-c(yr, k, m)) %>%
  cor() %>%
  data.frame()
threshold = 0.9
b1 <- allr < threshold
b2 <- allr > -threshold
allr[allr == 1] <- NA
allr[b1 & b2] <- NA

corrplot(
  is.corr = FALSE,
  corr = as.matrix(allr),
  type = "upper",
  upper = "number",
  na.label = "?"
)
```

##### threshold = `0.8`

```{r}
allr <- year2 %>%
  select(-c(yr, k, m)) %>%
  cor() %>%
  data.frame()
threshold = 0.8
b1 <- allr < threshold
b2 <- allr > -threshold
allr[allr == 1] <- NA
allr[b1 & b2] <- NA

corrplot(
  is.corr = FALSE,
  corr = as.matrix(allr),
  type = "upper",
  upper = "number",
  na.label = "?"
)
```

##### threshold = `0.7`

```{r}
allr <- year2 %>%
  select(-c(yr, k, m)) %>%
  cor() %>%
  data.frame()
threshold = 0.7
b1 <- allr < threshold
b2 <- allr > -threshold
allr[allr == 1] <- NA
allr[b1 & b2] <- NA

corrplot(
  is.corr = FALSE,
  corr = as.matrix(allr),
  type = "upper",
  upper = "number",
  na.label = "?"
)
```

##### threshold = `0.6`

```{r}
allr <- year2 %>%
  select(-c(yr, k, m)) %>%
  cor() %>%
  data.frame()
threshold = 0.6
b1 <- allr < threshold
b2 <- allr > -threshold
allr[allr == 1] <- NA
allr[b1 & b2] <- NA

corrplot(
  is.corr = FALSE,
  corr = as.matrix(allr),
  type = "upper",
  upper = "number",
  na.label = "?"
)
```


### Top correlated features {.tabset .tabset-pills}

Energy is included in each of the three strongest correlations. Energy is strongly related to acousticness, loudness and tempo. The three plots show each of the three features graphed vs energy. Each graph includes a line with a linear method to show the approximate linear regression line. While an increase in acousticness relates to a decrease in energy, an increase in loudness and tempo relates to an increase in energy.

#### Acousticness vs Energy

```{r}
year %>% 
  ggplot(aes(y = energy, x = acousticness)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle(
    label = "Acousticness vs Energy"
  ) +
  theme_bw()
```

#### Loudness vs Energy

```{r}
year %>% 
  ggplot(aes(y = energy, x = loudness)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle(
    label = "Loudness vs Energy"
  ) +
  theme_bw()
```

#### Tempo vs Energy

```{r}
year %>% 
  ggplot(aes(y = energy, x = tempo)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle(
    label = "Tempo vs Energy"
  ) +
  theme_bw()
```

### Tangental Correlations {.tabset .tabset-pills}

In the below graph and table we can again see that there are strong correlations between energy and the other features acousticness, loudness, and tempo. However, it is also interesting to note that those same three features that we found correlate strongly with energy also correlate with each other, although to a lesser degree.

It is hard to say what this means exactly, but it does suggest a few possibilities, and speak to the difference between correlation and causation. For example, there is a r-value of `-0.8715355` between tempo and loudness. However, since we know that both those features correlate even stronger with energy, it may be possible that what is more significant is their relation to energy. This shows that these features are all highly related, and the fact that they all also correlate highly with each other suggests these features all measure for something similar.

#### Graph

```{r}
pairs(year[,c(5, 2, 8, 10)])
```

#### Table

```{r}
correlate(year[,c(5, 2, 8, 10)])
```

## Genre Graphs
<!--
### Genres vs instrumentalness (geom_points)

```{r}
condensed %>% 
  ggplot(aes(y = simple_genre, x = instrumentalness)) +
  geom_point() +
  theme_bw()
``` 
-->

<!-- 
### Genres vs instrumentalness (geom_col) 

```{r}
condensed %>%
  select(simple_genre, instrumentalness) %>% 
  group_by(simple_genre) %>%
  summarise(mean_inst = mean(instrumentalness)) %>% 
  ggplot(aes(y = simple_genre, x = mean_inst)) +
  geom_col() +
  theme_bw()
```
-->

### Boxplots {.tabset .tabset-pills}

Look. Boxplots.

#### Acousticness

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = acousticness, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Danceability

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = danceability, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Duration_ms

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = duration_ms, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Energy

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = energy, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Instrumentalness

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = instrumentalness, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Liveness

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = liveness, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Loudness

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = loudness, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Speechiness

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = speechiness, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Valence

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = valence, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Tempo

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = tempo, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

#### Popularity

```{r}
condensed %>%
  ggplot(aes(y = simple_genre, x = popularity, fill = simple_genre)) +
  geom_boxplot() +
  theme_bw()
```

### Density Plots {.tabset .tabset-pill}

Look. Density plots.

```{r}
genres_names <- condensed$simple_genre %>% unique()

feature_names <- colnames(condensed %>% select(-c(genres, simple_genre, key, mode)))
```

<!-- #### random testing -->

```{r}
# condensed %>% 
#   group_by(simple_genre) %>% 
#   summarise(
#     n = n(),
#     ) %>% 
#   arrange(desc(n))

# condensed %>% 
#   filter(simple_genre == "other") %>% 
#   ggplot(aes(x = acousticness)) +
#   geom_density()

# condensed %>% 
#   filter(simple_genre == "pop") %>% 
#   ggplot(aes(x = acousticness)) +
#   geom_density()
# 
# condensed %>% 
#   filter(simple_genre == "indie") %>% 
#   ggplot(aes(x = acousticness)) +
#   geom_density()
# 
# condensed %>% 
#   filter(simple_genre == "rock") %>% 
#   ggplot(aes(x = acousticness)) +
#   geom_density()
```

```{r}

# colnames(condensed %>% select(-c(genres, key, mode, simple_genre)))
# acousticness danceability duration_ms energy instrumentalness liveness loudness speechiness tempo valence popularity  
# "acousticness" "danceability" "duration_ms" "energy" "instrumentalness" "liveness" "loudness" "speechiness" "tempo" "valence" "popularity"
```

```{r all-graphs}
# for (g in genres_names) {
#   for (f in feature_names) {
#     gr <- condensed %>%
#       filter(simple_genre == g) %>%
#       ggplot(aes_string(x = f)) +
#       geom_density() +
#       ggtitle(
#         label = str_c(g, " ", f)
#       ) +
#       theme_bw()
#     gr %>%
#       print()
#   }
# }

# Generate with for loop

# for (f in feature_names) {
#   gr <- condensed %>%
#     ggplot(aes_string(x = f, color = quote(simple_genre))) +
#     geom_density() +
#     ggtitle(label = str_c(f)) +
#     theme_bw()
#   gr %>%
#     print()
# }

# colnames(condensed %>% select(-c(genres, key, mode, simple_genre)))
```

#### acousticness

```{r}
condensed %>%
  ggplot(aes(x = acousticness, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "acousticness") +
  theme_bw()
```

#### danceability

```{r}
condensed %>%
  ggplot(aes(x = danceability, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "danceability") +
  theme_bw()
```

#### duration_ms

```{r}
condensed %>%
  ggplot(aes(x = duration_ms, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "duration_ms") +
  theme_bw()
```

#### energy

```{r}
condensed %>%
  ggplot(aes(x = energy, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "energy") +
  theme_bw()
```

#### instrumentalness

```{r}
condensed %>%
  ggplot(aes(x = instrumentalness, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "instrumentalness") +
  theme_bw()
```

#### liveness

```{r}
condensed %>%
  ggplot(aes(x = liveness, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "liveness") +
  theme_bw()
```

#### loudness

```{r}
condensed %>%
  ggplot(aes(x = loudness, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "loudness") +
  theme_bw()
```

#### speechiness

```{r}
condensed %>%
  ggplot(aes(x = speechiness, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "speechiness") +
  theme_bw()
```

#### tempo

```{r}
condensed %>%
  ggplot(aes(x = tempo, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "tempo") +
  theme_bw()
```

#### valence

```{r}
condensed %>%
  ggplot(aes(x = valence, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "valence") +
  theme_bw()
```

#### popularity

```{r}
condensed %>%
  ggplot(aes(x = popularity, color = simple_genre)) +
  geom_density() +
  ggtitle(label = "popularity") +
  theme_bw()
```

### t-tests {.tabset .tabset-pills}

```{r}
t_test = function(mean1, sd1, total1, mean2, sd2, total2)
{
  z = (mean1 - mean2) /
    sqrt((sd1 * sd1 / total1) + (sd2 * sd2 / total2))
  if (total1 > total2) {
    df = total2 - 1
  }
  else {
    df = total1 - 1
  }
  
  p_val = pt(z, df)
  return (p_val)
}
```


We ran t-tests to find differences between genres in the different features. The t-test statistic^[http://www.sthda.com/english/wiki/t-test-formula] is as follows:

* Let $a$ and $a$ be the two populations.
* Let $m_a$ and $m_b$ be the means of each population
* Let $s_a$ and $s_b$ be the standard deviations of each population
* Let $n_a$ and $n_b$ be the sizes of each population

$$
t = \frac{m_a - m_b}{\sqrt{\frac{s_a^2}{n_a}+\frac{s_b^2}{n_b}}}
$$

We use this test statistic to calculate the p-value by finding the corresponding quantile from the student t distribution with $\max(n_a, n_b)-1$ degrees of freedom. We do this test between every combination of genres for all features:

```{r}
# setup
foo <- condensed %>% 
  group_by(simple_genre) %>% 
  summarise(
    n = n(),
    # 
    m_ac = mean(acousticness),
    m_da = mean(danceability),
    m_du = mean(duration_ms),
    m_en = mean(energy),
    m_in = mean(instrumentalness),
    m_li = mean(liveness),
    m_lo = mean(loudness),
    m_sp = mean(speechiness),
    m_te = mean(tempo),
    m_va = mean(valence),
    m_po = mean(popularity),
    # 
    sd_ac = sd(acousticness),
    sd_da = sd(danceability),
    sd_du = sd(duration_ms),
    sd_en = sd(energy),
    sd_in = sd(instrumentalness),
    sd_li = sd(liveness),
    sd_lo = sd(loudness),
    sd_sp = sd(speechiness),
    sd_te = sd(tempo),
    sd_va = sd(valence),
    sd_po = sd(popularity),
  )
```

#### acousticness

All t-test between genres for acousticness.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_ac[i],
             foo$sd_ac[i],
             foo$n[i],
             foo$m_ac[j],
             foo$sd_ac[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### danceability

All t-test between genres for danceability.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_da[i],
             foo$sd_da[i],
             foo$n[i],
             foo$m_da[j],
             foo$sd_da[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### duration_ms

All t-test between genres for duration_ms.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_du[i],
             foo$sd_du[i],
             foo$n[i],
             foo$m_du[j],
             foo$sd_du[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### energy

All t-test between genres for energy.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_en[i],
             foo$sd_en[i],
             foo$n[i],
             foo$m_en[j],
             foo$sd_en[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### instrumentalness

All t-test between genres for instrumentalness.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_in[i],
             foo$sd_in[i],
             foo$n[i],
             foo$m_in[j],
             foo$sd_in[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### liveness

All t-test between genres for liveness.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_li[i],
             foo$sd_li[i],
             foo$n[i],
             foo$m_li[j],
             foo$sd_li[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### loudness

All t-test between genres for loudness.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_lo[i],
             foo$sd_lo[i],
             foo$n[i],
             foo$m_lo[j],
             foo$sd_lo[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### speechiness

All t-test between genres for speechiness.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_sp[i],
             foo$sd_sp[i],
             foo$n[i],
             foo$m_sp[j],
             foo$sd_sp[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### tempo

All t-test between genres for tempo.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_te[i],
             foo$sd_te[i],
             foo$n[i],
             foo$m_te[j],
             foo$sd_te[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### valence

All t-test between genres for valence.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_va[i],
             foo$sd_va[i],
             foo$n[i],
             foo$m_va[j],
             foo$sd_va[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr

# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

#### popularity

All t-test between genres for popularity.

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_po[i],
             foo$sd_po[i],
             foo$n[i],
             foo$m_po[j],
             foo$sd_po[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr
```

Filtered for only significant differences (`p-value < 0.5`).

```{r}
# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```


### Popularity

Find most popular by finding highest mean popularity.

```{r}
foo %>% 
  select(simple_genre, n, m_po, sd_po) %>% 
  arrange(desc(m_po))
```

t-test for popularity (again)

```{r}
arr <- array(numeric(),
              dim = c(21, 21),
              dimnames = c(foo[, "simple_genre"], foo[, "simple_genre"])) %>% 
    as.data.frame()

for (i in seq(21)) {
  for (j in seq(21)) {
    t <-
      t_test(foo$m_po[i],
             foo$sd_po[i],
             foo$n[i],
             foo$m_po[j],
             foo$sd_po[j],
             foo$n[j])
    # t %>% print()
    arr[i, j] <- round(t, 4)
  }
}

arr
```

Isolate most popular

```{r}
# Filter
arr2 <- arr
arr2[arr2 > 0.05] <- NA
arr2
```

Only look at the most popular music (rap).

```{r}
arr2[18]
```

Isolate genres that didn't have `p-value < 0.5` and therefore cannot be dismissed as not also as popular as rap.

```{r}
arr2[18] %>% filter(is.na(rap))
```





















<!--
## Feature comparisons 

### Graphs of Combinations of Features {.tabset .tabset-pills}

(All / many) combinations graphs:

#### Select few

```{r}
pairs(year[,c(5, 2, 7, 8)])
```

#### All

```{r}
pairs(year[2:12])
```

-->

# Discussion

We also discovered which features have the strongest linear correlations to each other, vs which features have no linear relationship. We found that energy has a correlation over the absolute value of 0.9 to three other features, acousticness, loudness and tempo. Acousticness has a negative correlation with energy while loudness and tempo both have positive correlations with energy. Considering that acousticness, loudness, and tempo are all measured based on set measurements, while energy is calculated from intensity and activity in the song, we can infer that acousticness, loudness, and tempo all affect the energy of a song.

A short-coming of our analysis is that we do not know how many songs are included in the data for each year. Some year’s data may be based on more songs than other years. 

Future work on this dataset could involve testing out more of the features relationships and seeing if they have strong models. We could also look for datasets from other music streaming services, such as Apple Music and Pandora. 


<!-- 
# Analysis [DO NOT INCLUDE]

> Your data analysis should include substantial data exploration including graphical and numerical summaries which do not appear in the final report. You may exclude such analysis by using include=FALSE in the corresponding R chunks.

```{r}
# Change settings below this line
knitr::opts_chunk$set(
  echo = TRUE,
  # results = FALSE,
  # fig.show = 'hide',
  warning = FALSE,
  message = FALSE
)
```

## Simplify genre categories

```{r}
genre <- read_csv("data/data_by_genres.csv", col_types = cols())
x <- genre %>% 
  select(genres) %>% 
  mutate(
    words = str_split(genres, "\\s"),
  )
all_terms <- tibble(term = unlist(x$words, recursive = FALSE))
# Top terms (double counts...)
genre_term_count <- all_terms %>% 
  group_by(term) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>% 
  head(20)
```


```{r}
# higher in case when get priority
condensed <- genre %>% 
  mutate(
    simple_genre = case_when(
      str_detect(genres, genre_term_count$term[1]) ~ genre_term_count$term[1],
      str_detect(genres, genre_term_count$term[2]) ~ genre_term_count$term[2],
      str_detect(genres, genre_term_count$term[3]) ~ genre_term_count$term[3],
      str_detect(genres, genre_term_count$term[4]) ~ genre_term_count$term[4],
      str_detect(genres, genre_term_count$term[5]) ~ genre_term_count$term[5],
      str_detect(genres, genre_term_count$term[6]) ~ genre_term_count$term[6],
      str_detect(genres, genre_term_count$term[7]) ~ genre_term_count$term[7],
      str_detect(genres, genre_term_count$term[8]) ~ genre_term_count$term[8],
      str_detect(genres, genre_term_count$term[9]) ~ genre_term_count$term[9],
      str_detect(genres, genre_term_count$term[10]) ~ genre_term_count$term[10],
      str_detect(genres, genre_term_count$term[11]) ~ genre_term_count$term[11],
      str_detect(genres, genre_term_count$term[12]) ~ genre_term_count$term[12],
      str_detect(genres, genre_term_count$term[13]) ~ genre_term_count$term[13],
      str_detect(genres, genre_term_count$term[14]) ~ genre_term_count$term[14],
      str_detect(genres, genre_term_count$term[15]) ~ genre_term_count$term[15],
      str_detect(genres, genre_term_count$term[16]) ~ genre_term_count$term[16],
      str_detect(genres, genre_term_count$term[17]) ~ genre_term_count$term[17],
      str_detect(genres, genre_term_count$term[18]) ~ genre_term_count$term[18],
      str_detect(genres, genre_term_count$term[19]) ~ genre_term_count$term[19],
      str_detect(genres, genre_term_count$term[20]) ~ genre_term_count$term[20],
      TRUE ~ "other"
    )
  )

# condensed %>% 
#   group_by(simple_genre) %>% 
#   summarise(n = n()) %>% 
#   arrange(desc(n))
```

## All feature vs. feature

```{r}
# for (var_name in colnames(year)[2:12]) {
#   condensed %>%
#     ggplot(aes(y = simple_genre, x = get(condensed, var_name))) +
#     geom_boxplot() %>%
#     print()
# }
```

## All r-values

```{r rows.print=11}
year <- read_csv("data/data_by_year.csv", col_types = cols())

# All r values
allr <- year %>%
  select(-c(year, key, mode)) %>%
  cor() %>%
  round(digits = 2) %>%
  data.frame()

library(corrr)
allr2 <- year %>% 
  select(-c(year, key, mode)) %>% 
  correlate()

allr2

allr3 <- allr2

allr4 <- allr2

threshold = 0.8
b1 <- allr4 < threshold
b2 <- allr4 > -threshold

allr4[b1 & b2] <- NA # only check values that are above threshold for r
allr4

threshold = 0.9
b1 <- allr3 < threshold
b2 <- allr3 > -threshold

allr3[b1 & b2] <- NA # only check values that are above threshold for r
allr3
```

### r-values {.tabset .tabset-pills}

Just display r-value on graphs:

```{r rename-year-tofit}
# > install.packages("corrplot")
library(corrplot)

# year %>% glimpse()

year2 <- year %>% 
  rename(
    yr = year,
    ac = acousticness,
    db = danceability,
    dur = duration_ms,
    en = energy,
    ins = instrumentalness,
    li = liveness,
    lo = loudness,
    sp = speechiness,
    tmp = tempo,
    val = valence,
    pop = popularity,
    k = key,
    m = mode
  )
```

#### Upper number

```{r}
corrplot(
  round(cor(year2[2:12]), 1),
  method = "number",
  type = "upper" # show only upper side
)
```

#### Upper color

```{r}
corrplot(
  round(cor(year2[2:12]), 1),
  method = "color",
  type = "upper" # show only upper side
)
```

```{r}
year %>% 
  ggplot(aes(x = energy, y = acousticness)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()

year %>% 
  ggplot(aes(x = energy, y = loudness)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()

year %>% 
  ggplot(aes(x = energy, y = tempo)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()
```




## Displaying all r-values

```{r}
# All graphs
# for (a in colnames(year)[2:12]) {
#   for (b in colnames(year)[2:12]) {
#     if (a > b) {
#       g <- year %>%
#         summarise(
#           a_var = get(a),
#           b_var = get(b)
#         ) %>% 
#         ggplot(aes(x = a_var, y = b_var)) +
#         geom_point() +
#         labs(
#           x = a,
#           y = b
#           )
#       print(g)
#     }
#   }
# }

# https://statsandr.com/blog/correlation-coefficient-and-correlation-test-in-r/

# only some
pairs(year[,c(5, 2, 7, 8)])

# all
pairs(year[2:12])
```

```{r}
# > install.packages("corrplot")
library(corrplot)

year_sh <- year %>% 
  rename(
    yr = year,
    ac = acousticness,
    db = danceability,
    dur = duration_ms,
    en = energy,
    ins = instrumentalness,
    li = liveness,
    lo = loudness,
    sp = speechiness,
    tmp = tempo,
    val = valence,
    pop = popularity,
    k = key,
    m = mode
  )

corrplot.mixed(
  round(cor(year_sh[2:12]), 1),
  lower = "number",
  upper = "color"
)
```
 
```{r}
genre_data <- read_csv("data/data_by_genres.csv")
year_data <- read_csv("data/data_by_year.csv")

ggplot(year_data) +
  geom_point(aes(x = year, y = acousticness))

ggplot(year_data) +
  geom_point(aes(x = year, y = danceability))

ggplot(year_data) +
  geom_point(aes(x = year, y = loudness))

ggplot(year_data) +
  geom_point(aes(x = year, y = liveness))

ggplot(year_data) +
  geom_point(aes(x = year, y = energy))

ggplot(year_data) +
  geom_point(aes(x = energy, y = loudness))
```
 
-->
 
# References 
